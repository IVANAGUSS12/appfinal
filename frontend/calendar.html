
<!doctype html><html lang="es"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Calendario</title>
<style>
body{margin:0;background:#f5f7f6;font:15px system-ui,Segoe UI,Roboto,Arial;color:#0e2720}
.wrap{max-width:1100px;margin:20px auto;padding:0 16px}
.card{background:#fff;border:1px solid #e6efea;border-radius:16px;box-shadow:0 18px 50px rgba(6,68,39,.12);padding:16px}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.day{border:1px solid #e6efea;border-radius:12px;min-height:90px;padding:8px}
.count{font-weight:700}
.legend{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #cfe2da}
.dot{width:10px;height:10px;border-radius:999px}
</style></head><body>
<div class="wrap">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
    <a class="btn" href="/menu.html" style="border:0;background:#064427;color:#fff;border-radius:10px;padding:10px 12px;font-weight:700;text-decoration:none">← Menú</a>
    <h1>Calendario quirúrgico</h1>
    <span></span>
  </div>
  <div class="card">
    <div class="legend" id="legend"></div>
    <div class="grid" id="grid"></div>
  </div>
</div>
<script>
function colorFor(code){ // color estable por sector
  let h=0; for(let i=0;i<code.length;i++) h=(h*31+code.charCodeAt(i))>>>0;
  const hue=h%360; return `hsl(${hue} 60% 60%)`;
}
async function load(){
  const today=new Date(); const y=today.getFullYear(), m=today.getMonth();
  const desde=new Date(y,m,1).toISOString().slice(0,10);
  const hasta=new Date(y,m+1,0).toISOString().slice(0,10);
  const r=await fetch(`/api/calendar-month?desde=${desde}&hasta=${hasta}`); const d=await r.json();
  const r2=await fetch('/api/ref/lists'); const lists=await r2.json();
  const grid=document.getElementById('grid'); grid.innerHTML='';
  const first=new Date(y,m,1).getDay(); const days=new Date(y,m+1,0).getDate();
  for(let i=0;i<first;i++) grid.appendChild(document.createElement('div'));
  const byDate = {}; (d.events||[]).forEach(e=> byDate[e.start]=e.count);
  for(let day=1; day<=days; day++){
    const iso=new Date(y,m,day).toISOString().slice(0,10);
    const div=document.createElement('div'); div.className='day';
    div.innerHTML=`<div style="font-weight:700">${day}</div><div class="count">${byDate[iso]||0} program.</div>`;
    div.onclick=()=> location.href=`/calendar_day.html?date=${iso}`;
    grid.appendChild(div);
  }
  const leg=document.getElementById('legend');
  leg.innerHTML=(lists.sectores||[]).map(s=>`<span class="tag"><span class="dot" style="background:${colorFor(s.codigo)}"></span>${s.nombre}</span>`).join('');
}
load();
</script>
</body></html>
