<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CEMIC · Oficina Virtual de Autorizaciones</title>
  <style>
    :root{
      --green:#064427; --green-2:#0e2720; --muted:#5c6e68; --bg:#f3f7f5;
      --card:#fff; --line:#e6efea; --shadow:0 12px 34px rgba(6,68,39,.08); --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--green-2);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    .wrap{max-width:960px;margin:28px auto;padding:0 18px}
    .title{background:var(--green);color:#fff;padding:16px 18px;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius);font-weight:900}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px;padding:18px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr} }
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,textarea{width:100%;padding:12px 14px;border:1px solid #cfe2da;border-radius:12px;font-size:15px;outline:none;background:#fff}
    textarea{min-height:110px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:#9dcab7;box-shadow:0 0 0 3px rgba(95,167,138,.15)}
    .row{display:flex;flex-direction:column}
    .full{grid-column:1 / -1}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--green);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">CEMIC · Oficina Virtual de Autorizaciones</div>
      <form id="form">
        <div class="grid">
          <div class="row">
            <label for="nombre">Nombre y apellido *</label>
            <input id="nombre" name="nombre" placeholder="Ej: Juan Pérez" required>
          </div>
          <div class="row">
            <label for="dni">DNI *</label>
            <input id="dni" name="dni" placeholder="Ej: 12345678" required>
          </div>

          <div class="row">
            <label for="email">Correo electrónico *</label>
            <input id="email" name="email" type="email" placeholder="paciente@mail.com" required>
          </div>
          <div class="row">
            <label for="telefono">Teléfono *</label>
            <input id="telefono" name="telefono" placeholder="11 5555-5555" required>
          </div>

          <div class="row">
            <label for="obra_social">Cobertura médica *</label>
            <select id="obra_social" name="cobertura" required>
              <option value="">Buscá o elegí de la lista</option>
            </select>
          </div>
          <div class="row">
            <label for="medico">Médico tratante *</label>
            <select id="medico" name="medico" required>
              <option value="">Buscá o elegí de la lista</option>
            </select>
          </div>

          <div class="row">
            <label for="sector">Sector *</label>
            <select id="sector" name="sector_code" required>
              <option value="">Elegí…</option>
            </select>
          </div>
          <div class="row">
            <label for="fecha_cx">Fecha de cirugía (opcional)</label>
            <input id="fecha_cx" name="fecha_cx" type="date" placeholder="dd/mm/aaaa">
          </div>

          <div class="row full">
            <label for="orden_medica">Foto de orden médica *</label>
            <input id="orden_medica" name="orden_medica" type="file" accept=".png,.jpg,.jpeg,.webp,.pdf" required>
          </div>
          <div class="row full">
            <label for="dni_file">Foto de DNI *</label>
            <input id="dni_file" name="dni_file" type="file" accept=".png,.jpg,.jpeg,.webp,.pdf" required>
          </div>
          <div class="row full">
            <label for="credencial">Foto de credencial *</label>
            <input id="credencial" name="credencial" type="file" accept=".png,.jpg,.jpeg,.webp,.pdf" required>
          </div>
          <div class="row full">
            <label for="orden_materiales">Orden de pedido de materiales (opcional)</label>
            <input id="orden_materiales" name="orden_materiales" type="file" accept=".png,.jpg,.jpeg,.webp,.pdf">
          </div>

          <div class="row full">
            <label for="observaciones">Observaciones</label>
            <textarea id="observaciones" name="observaciones" placeholder="Comentarios adicionales"></textarea>
            <div class="muted">Podés subir JPG, PNG o PDF. Máx. 15 MB por archivo.</div>
          </div>

          <div class="row full">
            <button class="btn" type="submit" id="btnEnviar">Enviar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Cargar listas desde la DB
    document.addEventListener('DOMContentLoaded', function(){
      (async function(){
        try{
          const r = await fetch('/api/ref/lists');
          const j = await r.json();
          const coberturas = j.coberturas || [];
          const medicos    = j.medicos || [];
          const sectores   = j.sectores || []; // [{codigo, nombre}] o strings

          const obraSel = document.getElementById('obra_social');
          const medSel  = document.getElementById('medico');
          const secSel  = document.getElementById('sector');

          function llenar(sel, arr, map){
            if(!sel) return;
            sel.innerHTML = '<option value="">Elegí…</option>';
            const usados = new Set();
            arr.forEach(x=>{
              const o = map ? map(x) : {value:x, text:x};
              if(!o || !o.text || usados.has(o.text)) return;
              const opt = document.createElement('option');
              opt.value = o.value; opt.textContent = o.text;
              sel.appendChild(opt); usados.add(o.text);
            });
          }

          llenar(obraSel, coberturas, x=>({value:x, text:x}));
          llenar(medSel,  medicos,    x=>({value:x, text:x}));
          llenar(secSel,  sectores,   s=>({value:(s.codigo??s), text:(s.nombre??s)}));
        }catch(err){
          console.error('No se pudieron cargar las listas', err);
        }
      })();
    });

    // Envío a /api/patients (multipart)
    (function(){
      const form = document.getElementById('form'), btn = document.getElementById('btnEnviar');
      if(!form) return;

      form.addEventListener('submit', async function(ev){
        ev.preventDefault();
        const fd = new FormData(form);

        // Validación simple de adjuntos obligatorios
        if(!fd.get('orden_medica') || !fd.get('dni_file') || !fd.get('credencial')){
          alert('Adjuntá orden médica, DNI y credencial.'); return;
        }

        btn.disabled = true; const old = btn.textContent; btn.textContent = 'Enviando…';
        try{
          const r = await fetch('/api/patients', { method:'POST', body: fd });
          const d = await r.json().catch(()=>({}));
          if(!r.ok) throw new Error(d.detail||('HTTP '+r.status));
          alert('Enviado correctamente');
          form.reset();
        }catch(err){
          alert('Error al enviar: ' + (err.message||err));
        }finally{
          btn.disabled=false; btn.textContent=old;
        }
      });
    })();
  </script>
</body>
</html>
