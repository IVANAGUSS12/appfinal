<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CEMIC · Panel Interno</title>

<style>
  :root{
    --bg:#f4f7f6; --card:#ffffff; --ink:#0e2720; --muted:#5c6e68; --line:#e6efea;
    --brand:#064427; --brand-2:#0a6a44; --chip:#eaf6ef; --danger:#c0392b;
    --shadow:0 18px 50px rgba(6,68,39,.12); --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial}
  h1{margin:0;font-weight:800;letter-spacing:.2px;font-size:22px;color:var(--brand)}
  a{color:var(--brand-2);text-decoration:none}

  .wrap{max-width:1280px;margin:26px auto;padding:0 16px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--line)}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
  input,select,button{border:1px solid #cfe2da;border-radius:12px;padding:10px 12px;background:#fff;font-size:14px}
  input::placeholder{color:#98a9a4}
  select{padding-right:28px}
  button{background:var(--brand);color:#fff;border:0;cursor:pointer;font-weight:700}
  button.secondary{background:#edf4f0;color:#064427}
  button.ghost{background:#fff;border:1px dashed #cfe2da;color:#064427}
  .grow{flex:1}
  .right{margin-left:auto}
  .muted{color:var(--muted);font-size:13px}

  .table-wrap{overflow:auto;max-height:72vh;border-radius:0 0 var(--radius) var(--radius)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#f7fbf9;z-index:2;font-weight:800;font-size:13px;border-bottom:1px solid var(--line)}
  th,td{padding:12px 14px;border-bottom:1px solid var(--line);vertical-align:middle}
  tr:hover{background:#fbfdfc}

  .chip{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;border:1px solid #cfe2da;background:#f1f7f4;font-weight:700}
  .s-pend{background:#fff6e5;color:#9a5b09;border:1px solid #ffd9a0}
  .s-auto{background:#e8fbf1;color:#0b5b3d;border:1px solid #b8ebcf}
  .s-fmat{background:#fffbe6;color:#7a5707;border:1px solid #ffe58a}
  .s-soli{background:#eef5ff;color:#2156b6;border:1px solid #cfe0ff}
  .s-mok{background:#ecf7ff;color:#0d5180;border:1px solid #ccecff}
  .s-autop{background:#eef0ff;color:#3730a3;border:1px solid #c7d2fe}

  .row-detail{background:#fcfefc}
  .detail-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px}
  .detail-grid .box{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .ttl{font-weight:800;font-size:13px;color:#2e5247;margin-bottom:6px}

  .pagination{display:flex;gap:10px;align-items:center;justify-content:flex-end;padding:12px}
  .kpi{font-weight:800;color:var(--brand-2)}

  /* Adjuntos */
  .folder{border:1px dashed #cfe2da;border-radius:12px;background:#f8fbf9;padding:10px;display:flex;align-items:center;gap:10px;cursor:pointer}
  .folder .ico{width:18px;height:18px;opacity:.8}
  .adj-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:10px}
  .adj-card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px}
  .adj-head{display:flex;gap:8px;align-items:center}
  .adj-name{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .adj-actions{display:flex;gap:8px;flex-wrap:wrap}

  /* Preview modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,25,18,.55);z-index:9999}
  .preview-wrap{width:min(96vw,1400px);height:min(90vh,880px);background:#000;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
  .preview-head{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:rgba(0,0,0,.35);color:#fff}
  .bigpreview{flex:1;width:100%;height:100%;border:0;background:#000}
  .btn-close{background:#fff;color:#064427;border:0;border-radius:10px;padding:6px 10px;font-weight:800}

  /* Drawers laterales */
  .drawer{position:fixed;inset:0;display:none;background:rgba(6,25,18,.5);z-index:9998}
  .drawer > .content{position:absolute;right:0;top:0;bottom:0;width:min(980px,95vw);background:#fff;border-left:1px solid var(--line);box-shadow:var(--shadow);display:flex;flex-direction:column}
  .drawer .head{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line)}
  .drawer .body{padding:14px;overflow:auto}
  .tag{display:inline-flex;align-items:center;gap:6px;background:#edf4f0;border:1px solid #cfe2da;border-radius:999px;padding:6px 10px;font-size:12px}

  /* Icon bar */
  .iconbar{display:flex;gap:6px;margin-left:auto}
  .iconbtn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;background:#edf4f0;border:1px solid #cfe2da;cursor:pointer}
  .iconbtn svg{width:18px;height:18px}

  /* Calendario */
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .cal-day{background:#fff;border:1px solid var(--line);border-radius:10px;padding:6px;min-height:96px;display:flex;flex-direction:column;cursor:pointer}
  .cal-day:hover{box-shadow:inset 0 0 0 2px #cfe2da}
  .cal-day .d{font-weight:800;color:#124c38}
  .cal-badge{margin-top:auto;background:#edf4f0;border:1px solid #cfe2da;border-radius:999px;padding:3px 7px;align-self:flex-start;font-size:12px}

  /* Login */
  .login-wrap{display:grid;place-items:center;min-height:100vh;padding:24px}
  .login{max-width:460px;width:100%;padding:22px}
  .login h2{margin:0 0 8px 0}
  .login .brand{font-weight:800;color:#064427;margin-bottom:14px}
  .login .help{color:#6b7e78}

  /* Zoom de estadísticas (dentro del drawer) */
  .st-zoom{position:absolute;inset:0;background:rgba(6,25,18,.55);display:none;align-items:center;justify-content:center;z-index:5}
  .st-zoom .box{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:18px;max-width:900px;width:92%}
</style>
</head>
<body>

<!-- PREVIEW MODAL -->
<div id="prevModal" class="modal">
  <div class="preview-wrap">
    <div class="preview-head">
      <div id="prevTitle" style="font-weight:700"></div>
      <button id="prevClose" class="btn-close">Cerrar</button>
    </div>
    <iframe id="prevFrame" class="bigpreview" title="Vista previa"></iframe>
  </div>
</div>

<!-- DRAWER: Calendario -->
<div id="drawerCal" class="drawer">
  <div class="content">
    <div class="head">
      <h2 style="margin:0">Calendario</h2>
      <span id="calMonthLabel" class="muted"></span>
      <div class="right">
        <button id="calPrev" class="secondary">◀</button>
        <button id="calNext" class="secondary">▶</button>
        <button id="calClose" class="secondary">Cerrar</button>
      </div>
    </div>
    <div class="body">
      <div id="calGrid" class="cal-grid" style="margin-bottom:14px"></div>
      <div id="calNote" class="muted"></div>
    </div>
  </div>
</div>

<!-- DRAWER: Estadísticas -->
<div id="drawerStats" class="drawer">
  <div class="content">
    <div class="head">
      <h2 style="margin:0">Estadísticas</h2>
      <div class="right"><button id="stClose" class="secondary">Cerrar</button></div>
    </div>
    <div class="body">
      <!-- filtros -->
      <div class="card" style="padding:12px;margin-bottom:12px;display:grid;grid-template-columns:repeat(6,1fr);gap:8px">
        <input id="stQ" placeholder="Buscar (nombre/DNI)…">
        <select id="stCob"><option value="">Cobertura (todas)</option></select>
        <select id="stMed"><option value="">Médico (todos)</option></select>
        <select id="stEst">
          <option value="">Estado (todos)</option>
          <option>Pendiente</option><option>Autorizado</option><option>Falta materiales</option>
          <option>Solicitado</option><option>Materiales OK</option><option>Autorizado material pendiente</option>
          <option>rechazado por cobertura</option>
        </select>
        <input id="stDesde" type="date" title="Desde">
        <input id="stHasta" type="date" title="Hasta">
        <div style="grid-column:1/-1"><button id="stRun" class="secondary">Actualizar estadísticas</button></div>
      </div>
      <!-- donuts -->
      <div id="statsWrap" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px"></div>
      <!-- zoom dentro del drawer -->
      <div id="stZoom" class="st-zoom"><div class="box"><div style="display:flex;justify-content:flex-end"><button id="stZoomClose" class="secondary">Cerrar</button></div><div id="stZoomBody" style="margin-top:8px"></div></div></div>
    </div>
  </div>
</div>

<!-- DRAWER: Usuarios (admin) -->
<div id="drawerUsers" class="drawer">
  <div class="content">
    <div class="head">
      <h2 style="margin:0">Usuarios</h2>
      <div class="right"><button id="usClose" class="secondary">Cerrar</button></div>
    </div>
    <div class="body">
      <div class="card" style="padding:12px;margin-bottom:12px">
        <div class="ttl">Crear usuario</div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">
          <input id="uNombre" placeholder="Nombre">
          <input id="uEmail" placeholder="Email">
          <select id="uRol"><option>operador</option><option>admin</option></select>
          <input id="uTel" placeholder="Teléfono">
          <input id="uCentro" placeholder="Centro">
        </div>
        <div style="margin-top:8px"><button id="uCrear" class="secondary">Crear</button></div>
      </div>
      <div id="usersList" class="card" style="padding:12px"></div>
    </div>
  </div>
</div>

<!-- DRAWER: Perfil -->
<div id="drawerProfile" class="drawer">
  <div class="content">
    <div class="head">
      <h2 style="margin:0">Perfil</h2>
      <div class="right"><button id="pfClose" class="secondary">Cerrar</button></div>
    </div>
    <div class="body">
      <div class="card" style="padding:12px;margin-bottom:12px">
        <div class="ttl">Datos</div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
          <input id="pfTel" placeholder="Teléfono">
          <input id="pfCentro" placeholder="Centro">
        </div>
        <div style="margin-top:8px"><button id="pfGuardar" class="secondary">Guardar</button></div>
      </div>
      <div class="card" style="padding:12px">
        <div class="ttl">Cambiar contraseña</div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
          <input id="pwOld" type="password" placeholder="Contraseña actual">
          <input id="pwNew" type="password" placeholder="Nueva contraseña">
        </div>
        <div style="margin-top:8px"><button id="pwCambiar" class="secondary">Cambiar</button></div>
      </div>
    </div>
  </div>
</div>

<!-- Placeholder -->
<div id="app"><div style="padding:24px;color:#567">Cargando…</div></div>

<script>
/* ===== Utils ===== */
const $=(s,root=document)=>root.querySelector(s);
const $$=(s,root=document)=>Array.from(root.querySelectorAll(s));
const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
const isImg=n=>/\.(png|jpe?g|gif|webp)$/i.test(n||'');

/* ===== Preview (si hay previewUrl → iframe; else imagen si aplica) ===== */
function openPreview(url,name,previewUrl){
  const frame = $('#prevFrame'); $('#prevTitle').textContent = name||'Vista previa';
  const goIframe = (u)=>{ frame.removeAttribute('srcdoc'); frame.src = u; };
  if (previewUrl){ // usar Drive preview siempre que esté
    goIframe(previewUrl);
  }else if (isImg(url)||isImg(name)){
    frame.srcdoc = `<!doctype html><meta charset=utf-8>
      <style>html,body{height:100%;margin:0;background:#000;display:grid;place-items:center}
      img{max-width:100%;max-height:100%;object-fit:contain}</style>
      <img src="${url}" alt="${esc(name||'')}">`;
  }else{
    goIframe(url);
  }
  $('#prevModal').style.display='flex';
}
$('#prevClose').onclick=()=>{ $('#prevModal').style.display='none'; $('#prevFrame').src='about:blank'; };

/* ===== Estado global ===== */
const State = {
  token:'', role:'operador', me:{ nombre:'', email:'' },
  total:0, rows:[],
  filters:{ q:'', cobertura:'', medico:'', estado:'', presupuesto:'', sortBy:'fecha_cx', sortDir:'desc', page:1, pageSize:50 },
  options:{ coberturas:[], medicos:[], estados:[] }
};
const canEdit = ()=> String(State.role||'').toLowerCase()==='admin';

/* ===== Login ===== */
function renderLogin(){
  $('#app').innerHTML = `
    <div class="login-wrap">
      <div class="card login">
        <div class="brand">CEMIC · Panel Interno</div>
        <h2>Ingresar</h2>
        <div class="help">Usá tu usuario del panel interno.</div>
        <div style="display:grid;gap:8px;margin-top:12px">
          <input id="lgEmail" placeholder="Email" autocomplete="username" />
          <input id="lgPass" type="password" placeholder="Contraseña" autocomplete="current-password" />
          <button id="lgGo">Entrar</button>
          <div id="lgMsg" class="muted"></div>
        </div>
      </div>
    </div>`;
  $('#lgGo').onclick=()=>{
    const e=$('#lgEmail').value.trim(), p=$('#lgPass').value.trim();
    $('#lgGo').disabled=true;
    google.script.run
      .withSuccessHandler(res=>{
        $('#lgGo').disabled=false;
        if(!res||res.ok===false){ $('#lgMsg').textContent=(res&&res.error)||'Login inválido'; return; }
        State.token=res.token||'ok';
        State.role=res.rol||'operador';
        State.me={nombre:res.nombre||'', email:res.email||''};
        renderPanel(); loadList(true);
      })
      .withFailureHandler(err=>{ $('#lgGo').disabled=false; $('#lgMsg').textContent=(err&&err.message)||String(err); })
      .login(e,p);
  };
}
function checkSession(){
  google.script.run
    .withSuccessHandler(res=>{
      if(res&&res.ok){
        State.token='ok';
        State.role=res.rol||'operador';
        State.me={nombre:res.nombre||'', email:res.email||''};
        renderPanel(); loadList(true);
      } else renderLogin();
    })
    .withFailureHandler(()=>renderLogin())
    .checkSession(State.token||'');
}

/* ===== Panel ===== */
function renderPanel(){
  $('#app').innerHTML = `
    <div class="wrap card">
      <div class="toolbar">
        <h1>CEMIC · Panel Interno de Autorizaciones</h1>
        <div class="iconbar">
          <button id="btnCal" class="iconbtn" title="Calendario" aria-label="Calendario">
            <svg viewBox="0 0 24 24" fill="none" stroke="#124c38" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="16" y1="2" x2="16" y2="6"/></svg>
          </button>
          <button id="btnStats" class="iconbtn" title="Estadísticas" aria-label="Estadísticas">
            <svg viewBox="0 0 24 24" fill="none" stroke="#124c38" stroke-width="2"><line x1="4" y1="19" x2="4" y2="10"/><line x1="12" y1="19" x2="12" y2="4"/><line x1="20" y1="19" x2="20" y2="14"/></svg>
          </button>
          ${canEdit()?`<button id="btnUsers" class="iconbtn" title="Usuarios" aria-label="Usuarios">
            <svg viewBox="0 0 24 24" fill="none" stroke="#124c38" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </button>`:''}
          <button id="btnProfile" class="iconbtn" title="Perfil" aria-label="Perfil">
            <svg viewBox="0 0 24 24" fill="none" stroke="#124c38" stroke-width="2"><circle cx="12" cy="7" r="4"/><path d="M20 21a8 8 0 1 0-16 0"/></svg>
          </button>
        </div>
        <span class="right kpi" id="kTotal">Total: —</span>
        <button id="btnExport" class="secondary">Exportar CSV</button>
        <button id="btnLogout" class="secondary">Salir</button>
      </div>

      <div class="toolbar">
        <input id="fQ" class="grow" placeholder="Buscar por nombre, DNI, cobertura, médico…">
        <select id="fCobertura"><option value="">Cobertura (todas)</option></select>
        <select id="fMedico"><option value="">Médico (todos)</option></select>
        <select id="fEstado">
          <option value="">Estado (todos)</option>
          ${['Pendiente','Autorizado','Falta materiales','Solicitado','Materiales OK','Autorizado material pendiente','rechazado por cobertura'].map(e=>`<option>${e}</option>`).join('')}
        </select>
        <select id="fPresupuesto">
          <option value="">Presupuesto (todos)</option>
          <option>Sin presupuesto</option><option>En curso</option><option>Aprobado</option>
        </select>
        <span class="muted">Ordenar</span>
        <select id="fSort">
          <option value="fecha_cx">Fecha cirugía</option>
          <option value="timestamp">Fecha carga</option>
          <option value="nombre">Nombre</option>
          <option value="dni">DNI</option>
        </select>
        <select id="fDir"><option value="desc">Desc</option><option value="asc">Asc</option></select>
        <button id="btnLimpiar" class="ghost">Limpiar</button>
        <button id="btnBuscar" class="secondary">Actualizar</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>#</th><th>NOMBRE</th><th>DNI</th><th>FECHA CIRUGÍA</th><th>ESTADO</th><th>ACCIONES</th>
          </tr></thead>
          <tbody id="tbody"><tr><td colspan="6" class="muted">Cargando…</td></tr></tbody>
        </table>
      </div>

      <div class="pagination">
        <span id="pagInfo" class="muted"></span>
        <button id="btnPrev" class="secondary">Anterior</button>
        <button id="btnNext" class="secondary">Siguiente</button>
      </div>
    </div>
  `;

  $('#btnLogout').onclick = ()=>{ google.script.run.withSuccessHandler(()=>{ State.token=''; renderLogin(); }).logout(); };
  $('#btnCal').onclick = openCalendar;
  $('#btnStats').onclick = openStats;
  if (canEdit()) $('#btnUsers').onclick = openUsers;
  $('#btnProfile').onclick = openProfile;

  $('#btnBuscar').onclick = ()=>{ grabFilters(); State.filters.page=1; loadList(false); };
  $('#btnLimpiar').onclick = ()=>{
    ['fQ','fCobertura','fMedico','fEstado','fPresupuesto'].forEach(id=>{ const el=$('#'+id); if(el) el.value=''; });
    $('#fSort').value='fecha_cx'; $('#fDir').value='desc';
    State.filters={ q:'', cobertura:'', medico:'', estado:'', presupuesto:'', sortBy:'fecha_cx', sortDir:'desc', page:1, pageSize:50 };
    loadList(true);
  };
  $('#btnPrev').onclick = ()=>{ const pages=Math.max(1,Math.ceil(State.total/State.filters.pageSize)); if(State.filters.page>1){ State.filters.page--; loadList(false);} };
  $('#btnNext').onclick = ()=>{ const pages=Math.max(1,Math.ceil(State.total/State.filters.pageSize)); if(State.filters.page<pages){ State.filters.page++; loadList(false);} };
  $('#btnExport').onclick = exportCSV;
  $('#fQ').onkeydown = e=>{ if(e.key==='Enter'){ grabFilters(); State.filters.page=1; loadList(false);} };
  $('#fCobertura').onchange = $('#fMedico').onchange = $('#fEstado').onchange = $('#fPresupuesto').onchange = ()=>{
    grabFilters(); State.filters.page=1; loadList(false);
  };
  $('#fSort').onchange = $('#fDir').onchange = ()=>{ grabFilters(); State.filters.page=1; loadList(false); };
}

/* ===== Data ===== */
function grabFilters(){
  State.filters.q=$('#fQ').value.trim();
  State.filters.cobertura=$('#fCobertura').value;
  State.filters.medico=$('#fMedico').value;
  State.filters.estado=$('#fEstado').value;
  State.filters.presupuesto=$('#fPresupuesto').value;
  State.filters.sortBy=$('#fSort').value||'fecha_cx';
  State.filters.sortDir=$('#fDir').value||'desc';
}
function loadList(resetOptions){
  google.script.run
    .withSuccessHandler(res=>{
      if(!res||res.ok===false){ $('#tbody').innerHTML='<tr><td colspan="6" class="muted">Error al listar</td></tr>'; return; }
      State.total=res.total||0; State.rows=res.rows||[];
      if(resetOptions){
        State.options.coberturas=res.coberturas||[]; State.options.medicos=res.medicos||[]; State.options.estados=res.estados||[];
        $('#fCobertura').innerHTML = '<option value="">Cobertura (todas)</option>'+State.options.coberturas.map(x=>`<option>${esc(x)}</option>`).join('');
        $('#fMedico').innerHTML = '<option value="">Médico (todos)</option>'+State.options.medicos.map(x=>`<option>${esc(x)}</option>`).join('');
        $('#stCob').innerHTML = '<option value="">Cobertura (todas)</option>'+State.options.coberturas.map(x=>`<option>${esc(x)}</option>`).join('');
        $('#stMed').innerHTML = '<option value="">Médico (todos)</option>'+State.options.medicos.map(x=>`<option>${esc(x)}</option>`).join('');
      }
      paintRows();
      const pages=Math.max(1,Math.ceil(State.total/State.filters.pageSize));
      $('#kTotal').textContent = `Total: ${State.total}`;
      $('#pagInfo').textContent=`Mostrando ${State.rows.length} de ${State.total} — pág. ${State.filters.page}/${pages}`;
    })
    .withFailureHandler(()=>{ $('#tbody').innerHTML='<tr><td colspan="6" class="muted">Sin datos</td></tr>'; })
    .listPacientes(Object.assign({},State.filters));
}

/* ===== Render filas ===== */
function chipEstado(estado){
  switch(String(estado||'Pendiente')){
    case 'Autorizado': return '<span class="chip s-auto">Autorizado</span>';
    case 'Falta materiales': return '<span class="chip s-fmat">Falta materiales</span>';
    case 'Solicitado': return '<span class="chip s-soli">Solicitado</span>';
    case 'Materiales OK': return '<span class="chip s-mok">Materiales OK</span>';
    case 'Autorizado material pendiente': return '<span class="chip s-autop">Autorizado mat. pendiente</span>';
    case 'rechazado por cobertura': return '<span class="chip s-pend" style="background:#fee2e2;border-color:#fecaca;color:#7f1d1d">Rechazado cobertura</span>';
    default: return '<span class="chip s-pend">Pendiente</span>';
  }
}
function rowHTML(p){
  const fecha = p.fecha_cx||'';
  const disabled = canEdit() ? '' : 'disabled';
  const hideAdmin = canEdit() ? '' : 'style="display:none"';
  return `
    <tr class="row" data-id="${p._row}">
      <td>${p._row}</td>
      <td><strong>${esc(p.nombre||'')}</strong><div class="muted">${esc(p.cobertura||'-')} · ${esc(p.medico||'-')}</div></td>
      <td>${esc(p.dni||'')}</td>
      <td><input ${disabled} type="date" class="inpFecha" value="${fecha}" style="height:34px;border-radius:8px;border:1px solid #cfe2da;padding:0 8px"></td>
      <td>
        <div class="chipWrap">${chipEstado(p.estado)}</div>
        <div style="margin-top:6px">
          <select ${disabled} class="selEstado" style="height:34px;border-radius:8px;border:1px solid #cfe2da;padding:0 8px">
            ${(State.options.estados||['Pendiente']).map(e=>`<option ${String(p.estado||'')===String(e)?'selected':''}>${e}</option>`).join('')}
          </select>
        </div>
      </td>
      <td>
        <button ${hideAdmin} class="secondary btnGuardar">Guardar</button>
        <button class="ghost btnDetalle">Detalle</button>
      </td>
    </tr>
    <tr class="row-detail" data-det="${p._row}" hidden>
      <td colspan="6">
        <div class="detail-grid">
          <div class="box"><div class="ttl">Contacto</div>
            <div class="muted">Email: ${esc(p.email||'—')}</div>
            <div class="muted">Tel: ${esc(p.telefono||'—')}</div>
            <div class="muted" style="margin-top:6px">Registro: ${esc(p.fecha_carga||'-')}</div>
          </div>
          <div class="box"><div class="ttl">Cobertura</div>${esc(p.cobertura||'')}</div>
          <div class="box"><div class="ttl">Médico</div>${esc(p.medico||'')}</div>
          <div class="box"><div class="ttl">Carpeta</div>
            ${p.subcarpeta_url?`<a href="${esc(p.subcarpeta_url)}" target="_blank" rel="noopener">Abrir carpeta</a>`:'<span class="muted">—</span>'}
          </div>

          <div class="box" style="grid-column:span 2">
            <div class="ttl">Presupuesto</div>
            <select ${disabled} class="selPres" style="height:34px;border-radius:8px;border:1px solid #cfe2da;padding:0 8px">
              <option ${p.presupuesto===''?'selected':''} value="">Sin presupuesto</option>
              <option ${p.presupuesto==='En curso'?'selected':''}>En curso</option>
              <option ${p.presupuesto==='Aprobado'?'selected':''}>Aprobado</option>
            </select>
            <input ${disabled} class="inpObsProv" placeholder="Obs. proveedores…" value="${esc(p.obs_proveedores||'')}" style="margin-top:8px;width:100%;height:34px;border:1px solid #cfe2da;border-radius:8px;padding:0 8px">
          </div>

          <div class="box" style="grid-column:span 2">
            <div class="ttl">Reprogramación</div>
            <div style="display:grid;grid-template-columns:160px 1fr;gap:8px">
              <input ${disabled} type="date" class="inpRepr" value="${p.reprogramacion||''}" style="height:34px;border:1px solid #cfe2da;border-radius:8px;padding:0 8px">
              <input ${disabled} class="inpObsRepr" placeholder="Obs. reprogramación…" value="${esc(p.observaciones_reprogramacion||'')}" style="height:34px;border:1px solid #cfe2da;border-radius:8px;padding:0 8px">
            </div>
          </div>

          <!-- Adjuntos -->
          <div class="box" style="grid-column:span 4">
            <div class="folder" data-fold="${p._row}">
              <svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path fill="#7aa693" d="M10 4l2 2h7a2 2 0 012 2v8.8c0 1.2-.9 2.2-2 2.2H5a2 2 0 01-2-2V6a2 2 0 012-2h5z"/></svg>
              <strong>Adjuntos</strong>
              <span class="muted">· clic para ver ${canEdit()?'/ subir':''}</span>
              <span class="muted" style="margin-left:auto">Vista previa / descarga</span>
            </div>
            <div class="adj-panel" data-panel="${p._row}" style="display:none">
              ${canEdit()?`
              <div class="uploader" style="display:flex;gap:8px;align-items:center;margin-top:10px">
                <select class="uTipo">
                  <option>Orden</option><option>Presupuesto</option><option>DNI</option><option>Credencial</option><option>Materiales</option><option>Otro</option>
                </select>
                <input type="file" class="uFile">
                <button class="secondary uBtn">Subir</button>
              </div>`:''}
              <div class="adj-grid" data-adj="${p._row}">
                <div class="muted">Cargando…</div>
              </div>
            </div>
          </div>
        </div>
      </td>
    </tr>
  `;
}
function paintRows(){
  const tbody=$('#tbody');
  if(!State.rows.length){ tbody.innerHTML='<tr><td colspan="6" class="muted">Sin resultados</td></tr>'; return; }
  tbody.innerHTML = State.rows.map(rowHTML).join('');
  State.rows.forEach(p=>{
    const tr = document.querySelector(`tr.row[data-id="${p._row}"]`);
    const det = document.querySelector(`tr.row-detail[data-det="${p._row}"]`);
    const btnDet = tr.querySelector('.btnDetalle');
    const btnGuardar = tr.querySelector('.btnGuardar');
    const inpFecha = tr.querySelector('.inpFecha');
    const selEstado = tr.querySelector('.selEstado');
    const chipWrap = tr.querySelector('.chipWrap');

    btnDet.onclick=()=>{ det.hidden = !det.hidden; if(!det.hidden){ loadAdjuntos(p, det); } };
    if (selEstado) selEstado.onchange=()=>{ chipWrap.innerHTML = chipEstado(selEstado.value); };
    if (btnGuardar) btnGuardar.onclick=()=>{
      const patch = {
        fecha_cx: inpFecha ? (inpFecha.value||'') : '',
        estado: selEstado ? (selEstado.value||'') : '',
        presupuesto: det.querySelector('.selPres')?.value||'',
        obs_proveedores: det.querySelector('.inpObsProv')?.value||'',
        reprogramacion: det.querySelector('.inpRepr')?.value||'',
        observaciones_reprogramacion: det.querySelector('.inpObsRepr')?.value||''
      };
      google.script.run
        .withSuccessHandler(()=>{ btnGuardar.textContent='Guardado'; setTimeout(()=>btnGuardar.textContent='Guardar',1200); })
        .withFailureHandler(err=>alert((err&&err.message)||String(err)))
        .updatePacientePatch(p._row, patch);
    };

    const fold = det.querySelector(`[data-fold="${p._row}"]`);
    const panel = det.querySelector(`[data-panel="${p._row}"]`);
    fold.onclick=()=>{ panel.style.display = panel.style.display==='none' ? 'block' : 'none'; };

    if (canEdit()){
      const uBtn = panel.querySelector('.uBtn');
      const uFile = panel.querySelector('.uFile');
      if (uBtn) uBtn.onclick=()=>{
        const f = uFile.files && uFile.files[0];
        if(!f){ alert('Elegí un archivo'); return; }
        const reader = new FileReader();
        reader.onload = function(){
          const base64 = reader.result.split(',')[1] || '';
          google.script.run
            .withSuccessHandler(()=>{ uFile.value=''; loadAdjuntos(p, det); })
            .withFailureHandler(err=> alert((err&&err.message)||String(err)))
            .uploadFileToPatient({
              folderUrl: p.subcarpeta_url || '',
              base64: base64,
              filename: f.name,
              mime: f.type || 'application/octet-stream'
            });
        };
        reader.readAsDataURL(f);
      };
    }
  });
}

/* ===== Adjuntos (usar previewUrl en iframe) ===== */
function adjCardHTML(f){
  const name = f.name || 'archivo';
  const preview = f.previewUrl || f.viewUrl || ''; // este va al iframe
  const imgCandidate = f.downloadUrl || '';        // por si no hay preview y es imagen
  const down = f.downloadUrl || f.viewUrl || f.previewUrl || '#';
  return `
    <div class="adj-card">
      <div class="adj-head">
        ${f.iconUrl ? `<img class="ico" src="${f.iconUrl}" alt="">` : ''}
        <div class="adj-name" title="${esc(name)}">${esc(name)}</div>
      </div>
      <div class="adj-actions">
        <button class="secondary btnPrev" data-prev="${preview}" data-img="${imgCandidate}" data-name="${esc(name)}">Vista previa</button>
        <a class="secondary" href="${down}" download target="_blank" rel="noopener" style="text-decoration:none;display:inline-block;padding:10px 12px;border-radius:12px;border:1px solid #cfe2da">Descargar</a>
      </div>
    </div>
  `;
}
function loadAdjuntos(p, detRoot){
  const grid = detRoot.querySelector(`[data-adj="${p._row}"]`);
  grid.innerHTML = '<div class="muted">Cargando…</div>';
  google.script.run
    .withSuccessHandler(res=>{
      const files = (res&&res.files)||[];
      if(!files.length){ grid.innerHTML='<div class="muted">Sin adjuntos</div>'; return; }
      grid.innerHTML = files.map(adjCardHTML).join('');
      grid.querySelectorAll('.btnPrev').forEach(b=>{
        const prev=b.dataset.prev||''; const img=b.dataset.img||''; const nm=b.dataset.name||'';
        b.onclick = ()=> openPreview(img,nm,prev);
      });
    })
    .withFailureHandler(()=>{ grid.innerHTML='<div class="muted">No se pudieron cargar los adjuntos</div>'; })
    .getAdjuntos(p.subcarpeta_url||'');
}

/* ===== Export ===== */
function exportCSV(){
  const period = prompt('Mes a exportar (YYYY-MM). Dejar vacío cancela.');
  if(!period) return;
  google.script.run
    .withSuccessHandler(res=>{
      if(!res||res.ok===false){ alert((res&&res.error)||'Error al exportar'); return; }
      if(res.base64){
        const a=document.createElement('a');
        a.href='data:'+res.mime+';base64,'+res.base64;
        a.download=res.filename||('autorizaciones_'+period+'.xlsx');
        document.body.appendChild(a); a.click(); a.remove();
      }else if(res.csv){
        const blob = new Blob([res.csv],{type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=res.filename||('autorizaciones_'+period+'.csv'); a.click(); URL.revokeObjectURL(url);
      }else{ alert('Nada para descargar.'); }
    })
    .withFailureHandler(err=> alert((err&&err.message)||String(err)))
    .exportPacientes({period});
}

/* ===== Calendario ===== */
let calRefDate = new Date();
function openCalendar(){
  $('#drawerCal').style.display='block';
  paintCalendar();
  $('#calPrev').onclick=()=>{ calRefDate.setMonth(calRefDate.getMonth()-1); paintCalendar(); };
  $('#calNext').onclick=()=>{ calRefDate.setMonth(calRefDate.getMonth()+1); paintCalendar(); };
  $('#calClose').onclick=()=>{ $('#drawerCal').style.display='none'; };
}
function paintCalendar(){
  const y=calRefDate.getFullYear(), m=calRefDate.getMonth();
  $('#calMonthLabel').textContent = calRefDate.toLocaleDateString('es-AR',{month:'long',year:'numeric'});
  const first = new Date(y,m,1), last = new Date(y,m+1,0);
  const start = new Date(first); start.setDate(first.getDate() - ((first.getDay()+6)%7));
  const end   = new Date(last);  end.setDate(last.getDate() + (6-((last.getDay()+6)%7)));

  google.script.run
    .withSuccessHandler(res=>{
      const counts={}; (res.events||[]).forEach(e=>{ counts[e.start]=e.count; });
      const g = $('#calGrid'); g.innerHTML='';
      for (let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        const inMonth = d.getMonth()===m;
        const iso = d.toISOString().slice(0,10);
        const c = counts[iso]||0;
        const div = document.createElement('div');
        div.className='cal-day';
        div.style.opacity = inMonth?1:.45;
        div.innerHTML = `<div class="d">${d.getDate()}</div>${c?`<div class="cal-badge">${c} turno(s)</div>`:''}`;
        div.onclick = ()=>{
          google.script.run
            .withSuccessHandler(r=>{
              $('#drawerCal').style.display='none';
              State.filters.page=1;
              State.total = r.total||0;
              State.rows  = r.rows||[];
              paintRows();
              $('#kTotal').textContent = `Total: ${State.total}`;
              $('#pagInfo').textContent=`Mostrando ${State.rows.length} de ${State.total} — día ${iso}`;
            })
            .getCalendarDay({fechaExacta:iso});
        };
        g.appendChild(div);
      }
      $('#calNote').textContent='Hacé clic en un día para ver sus turnos en la tabla.';
    })
    .getCalendarMonth({desde: new Date(y,m,1).toISOString().slice(0,10), hasta: new Date(y,m+1,0).toISOString().slice(0,10)});
}

/* ===== Estadísticas: donuts SVG + zoom ===== */
const PALETTE = ['#0fb49e','#7ed6a6','#1f7a62','#a7e3c1','#2d8c73','#cfeadf','#39a78d','#8edbb9'];
function polar(cx,cy,r,ang){ const a=(ang-90)*Math.PI/180; return [cx+r*Math.cos(a), cy+r*Math.sin(a)]; }
function donutSVG(data,title,W=320,H=240,R=90,r=56,showLegend=true){
  const entries = Object.entries(data||{}).filter(([k,v])=>v>0);
  const total = entries.reduce((s,[_k,v])=>s+v,0) || 1;
  let a0=0, segs='';
  entries.forEach(([k,v],i)=>{
    const a1 = a0 + (v/total)*360;
    const [x1,y1] = polar(W/2,H/2,R,a0), [x2,y2] = polar(W/2,H/2,R,a1);
    const large = (a1-a0) > 180 ? 1 : 0;
    const [ix1,iy1] = polar(W/2,H/2,r,a0), [ix2,iy2] = polar(W/2,H/2,r,a1);
    const color = PALETTE[i%PALETTE.length];
    const d = `M ${x1} ${y1} A ${R} ${R} 0 ${large} 1 ${x2} ${y2} L ${ix2} ${iy2} A ${r} ${r} 0 ${large} 0 ${ix1} ${iy1} Z`;
    segs += `<path d="${d}" fill="${color}" data-key="${esc(k)}" data-val="${v}"></path>`;
    a0=a1;
  });
  const centerLabel = `<text x="${W/2}" y="${H/2-2}" text-anchor="middle" font-size="18" font-weight="800" fill="#0a6a44">${total}</text>
  <text x="${W/2}" y="${H/2+16}" text-anchor="middle" font-size="11" fill="#5c6e68">Total</text>`;
  const legend = showLegend ? entries.map(([k,v],i)=>`
    <g transform="translate(8,${H-60 + i*16})">
      <rect width="10" height="10" rx="2" fill="${PALETTE[i%PALETTE.length]}"></rect>
      <text x="14" y="10" font-size="11" fill="#5c6e68">${esc(k)} (${v})</text>
    </g>`).join('') : '';
  return `<div class="card chart" style="padding:12px;cursor:pointer">
    <div class="ttl">${esc(title)}</div>
    <svg viewBox="0 0 ${W} ${H}" width="100%" height="260" role="img" aria-label="${esc(title)}">
      ${segs}${centerLabel}${legend}
    </svg>
  </div>`;
}
function openStats(){
  $('#drawerStats').style.display='block';
  $('#stClose').onclick=()=>{ $('#drawerStats').style.display='none'; };
  $('#stZoomClose').onclick=()=>{ $('#stZoom').style.display='none'; $('#stZoomBody').innerHTML=''; };
  const run = ()=>{
    const opts={
      q: $('#stQ').value.trim(),
      cobertura: $('#stCob').value,
      medico: $('#stMed').value,
      estado: $('#stEst').value,
      desde: $('#stDesde').value || undefined,
      hasta: $('#stHasta').value || undefined,
      page:1, pageSize:5000
    };
    google.script.run
      .withSuccessHandler(res=>{
        const w = $('#statsWrap'); w.innerHTML='';
        const blocks = [
          {t:'Por estado', d:res.estado||{}},
          {t:'Por cobertura', d:res.cobertura||{}},
          {t:'Por médico', d:res.medico||{}}
        ];
        w.innerHTML = blocks.map(b=>donutSVG(b.d,b.t)).join('');
        // zoom al click
        $$('#statsWrap .chart').forEach((card,idx)=>{
          card.onclick = ()=>{
            const big = donutSVG(blocks[idx].d, blocks[idx].t, 640, 420, 150, 96, true);
            $('#stZoomBody').innerHTML = big;
            $('#stZoom').style.display='flex';
          };
        });
      })
      .getStats(opts);
  };
  $('#stRun').onclick=run;
  // primera carga
  $('#stCob').value = State.filters.cobertura||'';
  $('#stMed').value = State.filters.medico||'';
  $('#stEst').value = State.filters.estado||'';
  run();
}

/* ===== Usuarios / Perfil ===== */
function openUsers(){
  $('#drawerUsers').style.display='block';
  $('#usClose').onclick=()=>{ $('#drawerUsers').style.display='none'; };
  const load = ()=>{
    google.script.run
      .withSuccessHandler(res=>{
        const list = $('#usersList');
        const rows = (res.rows||[]);
        list.innerHTML = rows.length ? rows.map(u=>`
          <div style="display:grid;grid-template-columns:2fr 2fr 1fr 1fr 1fr;gap:8px;padding:6px 0;border-bottom:1px dashed #e6efea">
            <div>${esc(u.nombre||'')}</div>
            <div class="muted">${esc(u.email||'')}</div>
            <div><span class="tag">${esc(u.rol||'')}</span></div>
            <div class="muted">${esc(u.telefono||'')}</div>
            <div class="muted">${esc(u.centro||'')}</div>
          </div>
        `).join('') : '<div class="muted">Sin usuarios</div>';
      })
      .adminListUsers();
  };
  $('#uCrear').onclick=()=>{
    const payload={
      nombre: $('#uNombre').value.trim(),
      email:  $('#uEmail').value.trim(),
      rol:    $('#uRol').value,
      telefono: $('#uTel').value.trim(),
      centro: $('#uCentro').value.trim()
    };
    google.script.run
      .withSuccessHandler(()=>{ ['uNombre','uEmail','uTel','uCentro'].forEach(id=>$('#'+id).value=''); load(); })
      .withFailureHandler(err=>alert((err&&err.message)||String(err)))
      .adminCreateUser(payload);
  };
  load();
}
function openProfile(){
  $('#drawerProfile').style.display='block';
  $('#pfClose').onclick=()=>{ $('#drawerProfile').style.display='none'; };
  $('#pfGuardar').onclick=()=>{
    const p={ telefono: $('#pfTel').value.trim(), centro: $('#pfCentro').value.trim() };
    google.script.run
      .withSuccessHandler(()=>alert('Guardado'))
      .withFailureHandler(err=>alert((err&&err.message)||String(err)))
      .saveUserProfile(p);
  };
  $('#pwCambiar').onclick=()=>{
    const a=$('#pwOld').value, b=$('#pwNew').value;
    google.script.run
      .withSuccessHandler(()=>{ alert('Contraseña cambiada'); $('#pwOld').value=''; $('#pwNew').value=''; })
      .withFailureHandler(err=>alert((err&&err.message)||String(err)))
      .changePasswordSelf(a,b);
  };
}

/* ===== init ===== */
function init(){ checkSession(); }
window.addEventListener('load', init);
</script>
<script src="shim.js"></script>
<script>
(function(){
  if (document.getElementById('log-migrado')) return;
  const wrap = document.createElement('section');
  wrap.id = 'log-migrado';
  wrap.style.margin = '16px 0';
  wrap.innerHTML = `
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input id="log-q" placeholder="Buscar paciente/DNI" style="padding:8px 10px;border:1px solid #cfe2da;border-radius:10px">
      <select id="log-estado" style="padding:8px 10px;border:1px solid #cfe2da;border-radius:10px">
        <option value="">Estado (todos)</option>
        <option>Pendiente</option><option>Autorizado</option><option>Falta materiales</option>
        <option>Solicitado</option><option>Materiales OK</option><option>Autorizado material pendiente</option>
        <option>rechazado por cobertura</option>
      </select>
      <button id="log-btn" style="padding:8px 12px;border:0;background:#064427;color:#fff;border-radius:10px;font-weight:700">Actualizar</button>
      <div style="margin-left:auto">Total: <b id="log-total">—</b></div>
    </div>
    <div id="log-list" style="margin-top:12px;display:grid;gap:10px"></div>
  `;
  const anchor = document.body || document.documentElement;
  anchor.appendChild(wrap);

  async function fetchPatients(){
    const q = document.getElementById('log-q').value || '';
    const estado = document.getElementById('log-estado').value || '';
    const r = await fetch(`/api/patients?q=${encodeURIComponent(q)}&estado=${encodeURIComponent(estado)}&page=1&pageSize=100`);
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }
  async function fetchFiles(pid){
    const r = await fetch(`/api/patients/${pid}/attachments`);
    if(!r.ok) return {files:[]};
    return r.json();
  }
  function isImg(url){ return /\.(png|jpe?g|gif|webp)$/i.test(url); }
  function isPdf(url){ return /\.pdf$/i.test(url); }

  async function render(){
    try{
      const data = await fetchPatients();
      document.getElementById('log-total').textContent = data.total || 0;
      const list = document.getElementById('log-list'); list.innerHTML='';
      for(const p of (data.rows||[])){
        const card = document.createElement('div');
        card.style.cssText='background:#fff;border:1px solid #e6efea;border-radius:14px;padding:12px;box-shadow:0 8px 28px rgba(6,68,39,.08)';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div><b>${p.nombre}</b> · ${p.dni||''}<div style="color:#5c6e68">${p.cobertura||''} · ${p.medico||''} · ${p.sector_code||''}</div></div>
            <div><span style="padding:4px 8px;border:1px solid #cfe2da;border-radius:999px;background:#eef7f1">${p.estado||'Pendiente'}</span></div>
          </div>
          <div class="adj-${p._row}" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div>
        `;
        list.appendChild(card);
        try{
          const files = await fetchFiles(p._row);
          const box = card.querySelector('.adj-'+p._row);
          for(const f of (files.files||[])){
            const a = document.createElement('a'); a.href=f.previewUrl||f.downloadUrl; a.target='_blank';
            a.style.cssText='display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid #cfe2da;border-radius:10px;text-decoration:none;color:#0e2720';
            if(isImg(f.previewUrl||'')){
              const img = document.createElement('img'); img.src=f.previewUrl; img.width=44; img.height=44; img.style.borderRadius='8px'; img.loading='lazy';
              a.prepend(img);
            }else if(isPdf(f.previewUrl||'')){
              const span = document.createElement('span'); span.textContent='PDF';
              span.style.cssText='font-weight:700';
              a.prepend(span);
            }
            a.append(f.name||'archivo');
            box.appendChild(a);
          }
        }catch(e){}
      }
    }catch(err){
      console.error('LOG error', err);
    }
  }
  document.getElementById('log-btn').addEventListener('click', render);
  render();
})();
</script>

</body></html>